<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Using the bestNormalize Package • bestNormalize</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Using the bestNormalize Package">
<meta property="og:description" content="bestNormalize">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">bestNormalize</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.8.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/bestNormalize.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/customization.html">Customization within bestNormalize</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/petersonR/bestNormalize/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="bestNormalize_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Using the bestNormalize Package</h1>
                        <h4 class="author">Ryan A Peterson</h4>
            
            <h4 class="date">2021-06-03</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/petersonR/bestNormalize/blob/master/vignettes/bestNormalize.Rmd"><code>vignettes/bestNormalize.Rmd</code></a></small>
      <div class="hidden name"><code>bestNormalize.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The <code>bestNormalize</code> package contains a suite of transformation-estimating functions that can be used to normalize data. The function of the same name attempts to find and execute the best of all of these potential normalizing transformations. In this package, we define “normalize” as in “to render data Gaussian”, rather than transform it to the 0-1 scale.</p>
<p>There are many instances where researchers may want to normalize a variable:</p>
<ol style="list-style-type: decimal">
<li><p>The (often problematic) assumption of normality of the outcome (conditional on the covariates) in the classical linear regression problem. Over the years many methods have been used to relax this assumption: generalized linear models, quantile regression, survival models, etc. One technique that is still somewhat popular in this context is to “beat the data” to look normal via some kind of normalizing transformation. This could be something as simple as a log transformation, or something as complex as a Yeo-Johnson transformation. While perhaps not the most elegant solution the problem, often this technique works well as a quick and dirty solution.</p></li>
<li><p>Another increasingly popular application of normalization occurs in applied regression settings with highly skewed distributions of the covariates. In these settings, there exists the tendency to have high leverage points (and highly influential points), even when one centers and scales the covariates. When examining interactions, these influential points can become especially problematic since the leverage of that point is amplified for every child interaction of which it is a parent. Normalization of the covariates mitigates the leverage and influence of these covariates, which allows for easier model selection. As a result, popular model selection packages such as <code>caret</code> and <code>recipes</code> have built-in mechanisms to normalize the predictor variables (they call this “preprocessing”). This concept is unique in that it forgoes the assumption of linearity between the outcome and the covariate, opting instead for a linear relationship between Y and the transformed value of the covariate (which in many cases may be more plausible).</p></li>
</ol>
<p>This package is designed to make this normalization transformation as effortless and consistent as possible. This package also introduces Ordered Quantile (ORQ) normalization via <code>orderNorm</code>, a normalization technique based off of a rank mapping to the normal distribution, which <em>guarantees</em> normally distributed transformed data (if ties are not present). We show in the accompanying paper that ORQ normalization performs very consistently across different distributions. It is able to successfully transform left/right skewed data, multimodal data, and even data generated from a Cauchy distribution (efficacy of transformation was tested on out-of-sample data).</p>
<p>The transformations contained in this package and implemented in <code>bestNormalize</code> are reversible (i.e., 1-1), which allows for straight-forward interpretation and consistency. In other words, any analysis performed on the normalized data can be interpreted using the original unit (see application).</p>
</div>
<div id="methods" class="section level1">
<h1 class="hasAnchor">
<a href="#methods" class="anchor"></a>Methods</h1>
<p>There are several normalization transformation options, each with their own implementations and limitations. While some of these methods are implemented well in other R packages, the <code>bestNormalize</code> package puts them all under the same umbrella syntax that makes them easy to apply in a wide range of situations.</p>
<div id="the-lambert-w-x-f-transformation" class="section level2">
<h2 class="hasAnchor">
<a href="#the-lambert-w-x-f-transformation" class="anchor"></a>The Lambert W x F transformation</h2>
<p>The Lambert W x F transformation, proposed by Goerg and implemented in the <code>LambertW</code> package, is essentially a mechanism that de-skews a random variable <span class="math inline">\(X\)</span> using moments. The method is motivated by a system theory, and is alleged to be able to transform any random variable into any other kind of random variable, thus being applicable to a large number of cases.</p>
<p>One of the package’s main functions is <code>Gaussianize</code>, which is similar in spirit to the purpose of this package. However, I have found in practice that often times, this method does not perform as well as the Box Cox or the Yeo-Johnson transformation.</p>
<p>This transformations can handle three types of transformations: skewed, heavy-tailed, and skewed heavy-tailed. For more details on this transformation, consult the documentation for the <code>Lambert W</code> package.</p>
</div>
<div id="the-box-cox-tranformation" class="section level2">
<h2 class="hasAnchor">
<a href="#the-box-cox-tranformation" class="anchor"></a>The Box Cox tranformation</h2>
<p>The Box Cox transformation, proposed by Box and Cox in their famous 1964 paper and implemented with differing syntax and methods in many packages in R (see <code>caret</code>, <code>MASS</code>, <code>forecast</code>), is a straightforward transformation that typically only involves one parameter, <span class="math inline">\(\lambda\)</span>:</p>
<p><span class="math display">\[
g(x; \lambda) = \boldsymbol 1 _{(\lambda \neq 0)} \frac{x^\lambda-1}{\lambda} 
+ \boldsymbol 1_{(\lambda = 0)} \log x
\]</span></p>
<p>Where <span class="math inline">\(x\)</span> refers to the datum in the original unit (pre-transformation). The <span class="math inline">\(\lambda\)</span> parameter can be estimated via maximum likelihood.</p>
</div>
<div id="the-yeo-johnson-transformation" class="section level2">
<h2 class="hasAnchor">
<a href="#the-yeo-johnson-transformation" class="anchor"></a>The Yeo-Johnson transformation</h2>
<p>The Yeo-Johnson transformation, proposed by Yeo and Johnson in 2000, attempts to find the value of lambda (in the following equation) that minimizes the Kullback-Leibler distance between the normal distribution and the transformed distribution.</p>
<p><span class="math display">\[
\begin{aligned}
g(x;\lambda) &amp;= 
\boldsymbol 1 _{(\lambda \neq 0, x \geq 0)} \frac{(x+1)^\lambda-1}{\lambda} \\
&amp;+ \boldsymbol 1_{(\lambda = 0, x \geq 0)} \log (x+1) \\
&amp;+ \boldsymbol 1_{(\lambda \neq 2, x &lt; 0)} \frac{(1-x)^{2-\lambda}-1}{\lambda - 2} \\
&amp;+ \boldsymbol 1_{(\lambda = 2, x &lt; 0)} -\log (1-x) \\
\end{aligned}
\]</span></p>
<p>This method has the advantage of working without having to worry about the domain of <span class="math inline">\(x\)</span>. As with the Box-Cox <span class="math inline">\(\lambda\)</span>, this <span class="math inline">\(\lambda\)</span> parameter can be estimated via maximum likelihood.</p>
</div>
<div id="the-ordered-quantile-technique" class="section level2">
<h2 class="hasAnchor">
<a href="#the-ordered-quantile-technique" class="anchor"></a>The Ordered Quantile technique</h2>
<p>The ORQ normalization technique is based on the following transformation (originally discussed, as far as I can find, by Bartlett in 1947 and further developed in 1952 by Van der Waerden in “Order tests for the two sample problem and their power”):</p>
<p>Let <span class="math inline">\(x\)</span> refer to the original data. Then the transformation is:</p>
<p><span class="math display">\[
g(x) = \Phi ^{-1} \left(\frac{\text{rank} (x) - 1/2}{\text{length}(x) }\right)
\]</span></p>
<p>ORQ normalization, while based on this transformation, is a little more complicated to implement in many settings where the transformation needs to be applied on new data.</p>
<p>On new data <em>within</em> the range of the original data, this transformation refers to the linear interpolation between two of the original data points. On new data <em>outside</em> the range of the original data, the transformation returns a warning and extrapolates using a shifted logit approximation of the ranks to the original data. This is visualized below via the <code>iris</code> data set, on the <code>Petal.Width</code> variable.</p>
<p><img src="bestNormalize_files/figure-html/orq_vis-1.png" width="672"></p>
<p>The reason for the shifted logit extrapolation is that it ensures that the function is 1-1, and can handle data outside the original (observed) domain. This approximation will usually be relatively minimal since we should not expect to see many observations outside the observed range if the sample size is large enough.</p>
<p>The ORQ technique will not guarantee a normal distribution in the presence of ties, but it still could yield the best normalizing transformation when compared to the other possible approaches.</p>
</div>
<div id="other-included-transformations" class="section level2">
<h2 class="hasAnchor">
<a href="#other-included-transformations" class="anchor"></a>Other included transformations</h2>
<p>In addition to the techniques above, the <code>bestNormalize</code> package performs and evaluates:</p>
<ul>
<li>
<span class="math inline">\(\log_b(x + a)\)</span> with <span class="math inline">\(a = \max(0, -\min(x) + \epsilon)\)</span> by default</li>
<li>
<span class="math inline">\(\sqrt{x + a}\)</span> with <span class="math inline">\(a = \max(0, -\min(x) + \epsilon)\)</span> by default</li>
<li><span class="math inline">\(\exp(x)\)</span></li>
<li><span class="math inline">\(\text {arcsinh}(x) = log(x + \sqrt{x^2 + 1})\)</span></li>
</ul>
</div>
<div id="other-not-included-transformations" class="section level2">
<h2 class="hasAnchor">
<a href="#other-not-included-transformations" class="anchor"></a>Other not-included transformations</h2>
<p>There have been a range of other normalization techniques discussed since the original Box-Cox paper that are not included in this package (at the time of writing). Many of these transformations have their own strengths and weaknesses.</p>
<p>These include (but are not limited to): Modified Box Cox (1964), Manly’s Exponential (1976), John/Draper’s Modulus (1980), Bickel/Doksum’s Modified Box Cox (1981).</p>
<p>The framework of this package is to create an S3 class for each transformation, so the addition of other normalization techniques would be easy extensions of this package (readers can feel free to submit a pull request to this package’s GitHub page with new transformation techniques if they feel so inclined).</p>
<p>The <code>bestNormalize</code> package does also include a function to perform a binarizing transformation. This is provided as a potential “last resort” if a vector is really unable to be transformed to a normally distributed variable. In cases when a user is automatically normalizing covariates, this is useful when they may accidentally try to normalize a vector with not enough unique values.</p>
</div>
<div id="selecting-the-best-technique" class="section level2">
<h2 class="hasAnchor">
<a href="#selecting-the-best-technique" class="anchor"></a>Selecting the best technique</h2>
<p>The <code>bestNormalize</code> function selects the best transformation according to the Pearson P statistic (divided by its degrees of freedom), as calculated by the <code>nortest</code> package. There are a variety of normality tests out there, but the benefit of the Pearson P / df is that it is a relatively interpretable goodness of fit test, and the ratio P / df can be compared between transformations as an absolute measure of the departure from normality (if the data follows close to a normal distribution, this ratio will be close to 1). The transformation whose transformed values fit normality the closest according to this statistic (or equivalently, this ratio), is selected by <code>bestNormalize</code>. The ratios are printed when the object is printed, see examples in the next section.</p>
<p>The ORQ technique is destined to win by this (in-sample) metric, since it is forcing the transformed data to follow a normal distribution. For this reason, by default the <code>bestNormalize</code> function calculates an <em>out-of-sample</em> estimate for the P / df statistic. Since this method requires repeated cross-validation, it can be a little bit problematic:</p>
<ol style="list-style-type: decimal">
<li>The results and the chosen transformation can depend on the seed,</li>
<li>It takes considerably longer to estimate than the in-sample statistic, and</li>
<li>It is unclear how to choose the number of folds and repeats</li>
</ol>
<p>To respond to these issues, (1) is only important for small sample sizes, and luckily the transformations chosen in cases where it’s a close call will look very similar to one another, so it shouldn’t make a practical difference. For (2), we have allowed for parallelization to slightly speed up this process, however there could be better ways of speeding this up. For (3), we recommend 10-fold cross-validation with 5 repeats as the default, but if the sample is small, it could be worth going to 5 folds instead with more repeats; accurate estimation of P/df requires a relatively large fold size (as a rule of thumb, 20 observations per fold seems to be enough for most cases, but this can vary of course depending on the distribution).</p>
<p>If the user specifies <code>out_of_sample = FALSE</code>, this will highly speed up the process as the function does not perform repeated CV. However the ORQ normalization will virtually always be chosen. If this method is chosen, we recommend also setting <code>allow_orderNorm = FALSE</code> in order to pick the best of the other transformations, otherwise the user may as well choose <code>orderNorm</code> to begin with.</p>
<p>The parallelization for <code>bestNormalize</code> is performed via the <code>parallel</code> package, and implemented by using the <code>cluster</code> argument. Users should create a cluster using <code>makeCluster</code>, then pass that cluster into the <code>bestNormalize</code> function (see Parallel in “Examples” section). The amount that this speeds up the estimation of out-of-sample estimates depends on the number of repeats, the number of cores, and the sample size of the vector to be normalized. The plot below shows the estimation time for 10-fold cross-validation with 15 repeats on a gamma distributed random variable with various sample sizes and cores. Note that the estimates below do not count the time it takes to call <code>makeCluster</code> or <code>stopCluster</code>. Evidently, the speed-up occurs past a few thousand observations for 15 repeats.</p>
<p><img src="parallel_timings.jpg" width="75%"></p>
</div>
</div>
<div id="examples" class="section level1">
<h1 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h1>
<p>In this section, I provide some code that performs each of the transformations described in the prior section.</p>
<div id="basic-implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#basic-implementation" class="anchor"></a>Basic Implementation</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Generate some data</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">250</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">x</span>, nbins <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/gen_data-1.png" width="672"></p>
<p>This data is clearly not normal. Let’s use the <code>bestNormalize</code> functionality to perform a suite of potential transformations, and see how each method performs.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Perform some tranformations individually</span>

<span class="co"># arcsinh transformation</span>
<span class="op">(</span><span class="va">arcsinh_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/arcsinh_x.html">arcsinh_x</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Standardized asinh(x) Transformation with 250 nonmissing obs.:
##  Relevant statistics:
##  - mean (before standardization) = 0.7383146 
##  - sd (before standardization) = 0.5458515</code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Box Cox's Transformation</span>
<span class="op">(</span><span class="va">boxcox_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/boxcox.html">boxcox</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Standardized Box Cox Transformation with 250 nonmissing obs.:
##  Estimated statistics:
##  - lambda = 0.3254863 
##  - mean (before standardization) = -0.3659267 
##  - sd (before standardization) = 0.9807881</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Yeo-Johnson's Transformation</span>
<span class="op">(</span><span class="va">yeojohnson_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/yeojohnson.html">yeojohnson</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Standardized Yeo-Johnson Transformation with 250 nonmissing obs.:
##  Estimated statistics:
##  - lambda = -0.7080476 
##  - mean (before standardization) = 0.4405464 
##  - sd (before standardization) = 0.2592004</code></pre>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># orderNorm Transformation</span>
<span class="op">(</span><span class="va">orderNorm_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/orderNorm.html">orderNorm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## orderNorm Transformation with 250 nonmissing obs and no ties 
##  - Original quantiles:
##    0%   25%   50%   75%  100% 
## 0.001 0.268 0.721 1.299 4.161</code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Pick the best one automatically</span>
<span class="op">(</span><span class="va">BNobject</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bestNormalize.html">bestNormalize</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Best Normalizing transformation with 250 Observations
##  Estimated Normality Statistics (Pearson P / df, lower =&gt; more normal):
##  - arcsinh(x): 1.7917
##  - Box-Cox: 1.0442
##  - Center+scale: 3.0102
##  - Exp(x): 9.5306
##  - Log_b(x+a): 1.7072
##  - orderNorm (ORQ): 1.1773
##  - sqrt(x + a): 1.144
##  - Yeo-Johnson: 1.1875
## Estimation method: Out-of-sample via CV with 10 folds and 5 repeats
##  
## Based off these, bestNormalize chose:
## Standardized Box Cox Transformation with 250 nonmissing obs.:
##  Estimated statistics:
##  - lambda = 0.3254863 
##  - mean (before standardization) = -0.3659267 
##  - sd (before standardization) = 0.9807881</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Last resort - binarize</span>
<span class="op">(</span><span class="va">binarize_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/binarize.html">binarize</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Binarize Transformation with 250 nonmissing obs.
## Estimated Statistic:
##  - median = 0.7211385</code></pre>
<p>These objects can then be fed into the <code>predict</code> function to perform the transformation on new values. The reverse transformation is also possible with this function. Below we plot the transformation for a range of new x values</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">xx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">arcsinh_obj</span>, newdata <span class="op">=</span> <span class="va">xx</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="fl">1</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">4</span>, <span class="fl">4</span><span class="op">)</span>,
     xlab <span class="op">=</span> <span class="st">'x'</span>, ylab <span class="op">=</span> <span class="st">"g(x)"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">boxcox_obj</span>, newdata <span class="op">=</span> <span class="va">xx</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">yeojohnson_obj</span>, newdata <span class="op">=</span> <span class="va">xx</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">orderNorm_obj</span>, newdata <span class="op">=</span> <span class="va">xx</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"bottomright"</span>, legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"arcsinh"</span>, <span class="st">"Box Cox"</span>, <span class="st">"Yeo-Johnson"</span>, <span class="st">"OrderNorm"</span><span class="op">)</span>, 
       col <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">4</span>, lty <span class="op">=</span> <span class="fl">1</span>, bty <span class="op">=</span> <span class="st">'n'</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/vis_data-1.png" width="672"></p>
<p>To examine how each of them performed (In-Sample), we can visualize the transformed values in a histogram.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">arcsinh_obj</span><span class="op">$</span><span class="va">x.t</span>, main <span class="op">=</span> <span class="st">"Arcsinh transformation"</span>, nbins <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">boxcox_obj</span><span class="op">$</span><span class="va">x.t</span>, main <span class="op">=</span> <span class="st">"Box Cox transformation"</span>, nbins <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">yeojohnson_obj</span><span class="op">$</span><span class="va">x.t</span>, main <span class="op">=</span> <span class="st">"Yeo-Johnson transformation"</span>, nbins <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">orderNorm_obj</span><span class="op">$</span><span class="va">x.t</span>, main <span class="op">=</span> <span class="st">"orderNorm transformation"</span>, nbins <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/hist_trans-1.png" width="672"></p>
<p>The best transformation in this case is plotted below.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">BNobject</span><span class="op">$</span><span class="va">x.t</span>, 
               main <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Best Transformation:"</span>, 
                            <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">BNobject</span><span class="op">$</span><span class="va">chosen_transform</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, nbins <span class="op">=</span> <span class="fl">12</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">BNobject</span>, newdata <span class="op">=</span> <span class="va">xx</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, col <span class="op">=</span> <span class="fl">1</span>, 
     main <span class="op">=</span> <span class="st">"Best Normalizing transformation"</span>, ylab <span class="op">=</span> <span class="st">"g(x)"</span>, xlab <span class="op">=</span> <span class="st">"x"</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/hist_best-1.png" width="672"></p>
</div>
<div id="visualizing-out-of-sample-estimates-of-normality" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-out-of-sample-estimates-of-normality" class="anchor"></a>Visualizing out-of-sample estimates of normality</h2>
<p>The <code>bestNormalize</code> function will save the estimated normality statistics that it obtained for each fold and repeat of cross-validation. Users can visualize these relatively easily via a boxplot (see below), which may give some insight into how much the transformation is truly preferred by the normality statistic, or if it doesn’t matter so much as much which transformation is chosen. In this example, Box-Cox, Arcsin h, and ORQ seem to be doing similarly to each other, whereas the Yeo-Johnson is under-performing.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/boxplot.html">boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">BNobject</span><span class="op">$</span><span class="va">oos_preds</span><span class="op">)</span>, yaxt <span class="op">=</span> <span class="st">'n'</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/axis.html">axis</a></span><span class="op">(</span><span class="fl">2</span>, at<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>,<span class="fl">.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span>, labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">.1</span>,<span class="fl">.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/boxplot-1.png" width="100%"></p>
</div>
<div id="improving-speed-of-estimation" class="section level2">
<h2 class="hasAnchor">
<a href="#improving-speed-of-estimation" class="anchor"></a>Improving speed of estimation</h2>
<p>The <code>bestNormalize</code> function can be quite slow, since it’s using cross validation to estimate the out-of-sample efficacy. If the user specifies <code>out_of_sample = FALSE"</code>, this will highly speed up the process, however the ORQ normalization will virtually always be chosen. If this method is chosen, we recommend setting <code>allow_orderNorm = FALSE</code> in order to pick the best of the other transformations.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/bestNormalize.html">bestNormalize</a></span><span class="op">(</span><span class="va">x</span>, allow_orderNorm <span class="op">=</span> <span class="cn">FALSE</span>, out_of_sample <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<pre><code>## Best Normalizing transformation with 250 Observations
##  Estimated Normality Statistics (Pearson P / df, lower =&gt; more normal):
##  - arcsinh(x): 4.401
##  - Box-Cox: 0.7435
##  - Center+scale: 8.087
##  - Exp(x): 64.6975
##  - Log_b(x+a): 3.47
##  - sqrt(x + a): 0.9145
##  - Yeo-Johnson: 1.7125
## Estimation method: In-sample
##  
## Based off these, bestNormalize chose:
## Standardized Box Cox Transformation with 250 nonmissing obs.:
##  Estimated statistics:
##  - lambda = 0.3254863 
##  - mean (before standardization) = -0.3659267 
##  - sd (before standardization) = 0.9807881</code></pre>
<p>We also make it easy for users to parallelize the repeated CV process via the <code>cluster</code> argument and the <code>parallel</code> package. A cluster can be set up with <code>makeCluster</code> and passed to <code>bestNormalize</code> via the <code>cluster =</code> argument.</p>
<p>This speed-up is dependent on the number of repeats, the length of the vector to be transformed, and the number of cores in the cluster. It could well make the computation slower due to the overhead computations of setting up the process, so in cases where the sample size is relatively small and the number of repeats is also small, it is probably better to not worry about the parallelization.</p>
</div>
<div id="leave-one-out-cv" class="section level2">
<h2 class="hasAnchor">
<a href="#leave-one-out-cv" class="anchor"></a>Leave-one-out CV</h2>
<p>As of version 1.3, <code>bestNormalize</code> has the <code>loo</code> argument, which if set to <code>TRUE</code> will compute the leave-one-out cross-validation transformations for each observation and method. Instead of the out-of-sample estimates for normality being the mean of the values over repeated folds, now the estimate for normality is simply calculated for the distribution of leave-one-out transformed values. This is computationally difficult, so it also works with the <code>cluster</code> argument if desired.</p>
</div>
<div id="visualizing-transformations-in-ggplot2-with-scales-package" class="section level2">
<h2 class="hasAnchor">
<a href="#visualizing-transformations-in-ggplot2-with-scales-package" class="anchor"></a>Visualizing transformations in <code>ggplot2</code> with <code>scales</code> package</h2>
<p>As of version 1.7, users can use the <code>scales</code> package in conjunction with <code>ggplot2</code> to facilitate plotting variables that have undergone a transformation with <code>bestNormalize</code> (or any other method).</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html">rgamma</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">1</span>, <span class="fl">.1</span><span class="op">)</span>
<span class="va">bn</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bestNormalize.html">bestNormalize</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>

<span class="va">bn</span></code></pre></div>
<pre><code>## Best Normalizing transformation with 1000 Observations
##  Estimated Normality Statistics (Pearson P / df, lower =&gt; more normal):
##  - arcsinh(x): 1.4556
##  - Box-Cox: 1.088
##  - Center+scale: 6.9536
##  - Exp(x): 115.8928
##  - Log_b(x+a): 2.0484
##  - orderNorm (ORQ): 1.1852
##  - sqrt(x + a): 1.5487
##  - Yeo-Johnson: 1.1946
## Estimation method: Out-of-sample via CV with 10 folds and 5 repeats
##  
## Based off these, bestNormalize chose:
## Standardized Box Cox Transformation with 1000 nonmissing obs.:
##  Estimated statistics:
##  - lambda = 0.2567004 
##  - mean (before standardization) = 2.392499 
##  - sd (before standardization) = 1.893565</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># say y is related linearly to the transformed x</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="va">bn</span><span class="op">$</span><span class="va">x.t</span> <span class="op">*</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">)</span>

<span class="co"># A log transformation does OK...</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="st">"log"</span>, breaks <span class="op">=</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/breaks_log.html">log_breaks</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/scales_ex-1.png" width="672"></p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Create bestNormalize scale for use in ggplot (using bestNormalize object)</span>
<span class="va">bn_trans</span> <span class="op">&lt;-</span> <span class="fu">scales</span><span class="fu">::</span><span class="fu"><a href="https://scales.r-lib.org/reference/trans_new.html">trans_new</a></span><span class="op">(</span>
  name <span class="op">=</span> <span class="st">"bn_trans"</span>,
  trans <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">bn</span>, newdata <span class="op">=</span> <span class="va">x</span><span class="op">)</span>,
  inverse <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">bn</span>, newdata <span class="op">=</span> <span class="va">x</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="op">)</span>


<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span>,y<span class="op">=</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_x_continuous</a></span><span class="op">(</span>trans <span class="op">=</span> <span class="va">bn_trans</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/scales_ex-2.png" width="672"></p>
</div>
</div>
<div id="application-to-autotrader-data" class="section level1">
<h1 class="hasAnchor">
<a href="#application-to-autotrader-data" class="anchor"></a>Application to <code>autotrader</code> data</h1>
<p>The <code>autotrader</code> data set was scraped from the <a href="https://www.autotrader.com/">autotrader website</a> as part of this package (and because at the time of writing, I needed to buy a car). I apply the <code>bestNormalize</code> functionality to de-skew mileage, age, and price in my pricing model. See <code><a href="../reference/autotrader.html">?autotrader</a></code> for more information on this data set.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"autotrader"</span><span class="op">)</span>
<span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span> <span class="op">&lt;-</span> <span class="fl">2017</span> <span class="op">-</span> <span class="va">autotrader</span><span class="op">$</span><span class="va">Year</span>
<span class="co">### Using best-normalize</span>
<span class="op">(</span><span class="va">priceBN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bestNormalize.html">bestNormalize</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">price</span>, r <span class="op">=</span> <span class="fl">1</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Best Normalizing transformation with 6283 Observations
##  Estimated Normality Statistics (Pearson P / df, lower =&gt; more normal):
##  - arcsinh(x): 7.3646
##  - Box-Cox: 4.2174
##  - Center+scale: 6.527
##  - Log_b(x+a): 7.3646
##  - orderNorm (ORQ): 1.1586
##  - sqrt(x + a): 4.2754
##  - Yeo-Johnson: 4.2174
## Estimation method: Out-of-sample via CV with 5 folds and 1 repeats
##  
## Based off these, bestNormalize chose:
## orderNorm Transformation with 6283 nonmissing obs and ties
##  - 2465 unique values 
##  - Original quantiles:
##    0%   25%   50%   75%  100% 
##   722 11499 15998 21497 64998</code></pre>
<p>Note that <code>orderNorm</code> throws a warning due to the ties in the price vector. We can see that the estimated normality statistic for the OrderNorm transformation is close to one, however, so we know it is performing quite well. It is also performing better than all of the other transformations.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">mileageBN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bestNormalize.html">bestNormalize</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">mileage</span>, r <span class="op">=</span> <span class="fl">1</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Best Normalizing transformation with 6283 Observations
##  Estimated Normality Statistics (Pearson P / df, lower =&gt; more normal):
##  - arcsinh(x): 4.7664
##  - Box-Cox: 4.2613
##  - Center+scale: 22.0413
##  - Log_b(x+a): 4.7657
##  - orderNorm (ORQ): 1.1199
##  - sqrt(x + a): 7.2496
##  - Yeo-Johnson: 4.2627
## Estimation method: Out-of-sample via CV with 5 folds and 1 repeats
##  
## Based off these, bestNormalize chose:
## orderNorm Transformation with 6283 nonmissing obs and ties
##  - 6077 unique values 
##  - Original quantiles:
##     0%    25%    50%    75%   100% 
##      2  29099  44800  88950 325556</code></pre>
<p>Similarly, the ORQ normalization performed best for mileage, and the ties didn’t seem to be too big of a deal.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">yearsoldBN</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bestNormalize.html">bestNormalize</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span>, r <span class="op">=</span> <span class="fl">1</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>## Best Normalizing transformation with 6283 Observations
##  Estimated Normality Statistics (Pearson P / df, lower =&gt; more normal):
##  - arcsinh(x): 170.512
##  - Box-Cox: 170.4444
##  - Center+scale: 171.1519
##  - Exp(x): 1034.8401
##  - Log_b(x+a): 170.4138
##  - orderNorm (ORQ): 168.0324
##  - sqrt(x + a): 170.5971
##  - Yeo-Johnson: 171.914
## Estimation method: Out-of-sample via CV with 5 folds and 1 repeats
##  
## Based off these, bestNormalize chose:
## orderNorm Transformation with 6283 nonmissing obs and ties
##  - 17 unique values 
##  - Original quantiles:
##   0%  25%  50%  75% 100% 
##    1    3    4    7   17</code></pre>
<p>Here we see something peculiar; none of the normalizing transformations performed well according to the normality statistics. The frequency of ties in this case makes it very difficult to find a normalizing transformation (see figure below as to why this is). Even so, orderNorm is chosen as it has the lowest estimated P/df statistic.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">price</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">priceBN</span><span class="op">$</span><span class="va">x.t</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">mileage</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">mileageBN</span><span class="op">$</span><span class="va">x.t</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span><span class="op">)</span>
<span class="fu">MASS</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/MASS/man/truehist.html">truehist</a></span><span class="op">(</span><span class="va">yearsoldBN</span><span class="op">$</span><span class="va">x.t</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/hist_app-1.png" width="672"></p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="va">price.xx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">price</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">price</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">mileage.xx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">mileage</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">mileage</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>
<span class="va">yearsold.xx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span><span class="op">)</span>, length <span class="op">=</span> <span class="fl">100</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">price.xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">priceBN</span>, newdata <span class="op">=</span> <span class="va">price.xx</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, 
     main <span class="op">=</span> <span class="st">"Price bestNormalizing transformation"</span>, 
     xlab <span class="op">=</span> <span class="st">"Price ($)"</span>, ylab <span class="op">=</span> <span class="st">"g(price)"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">mileage.xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">mileageBN</span>, newdata <span class="op">=</span> <span class="va">mileage.xx</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, 
     main <span class="op">=</span> <span class="st">"Mileage bestNormalizing transformation"</span>, 
     xlab <span class="op">=</span> <span class="st">"Mileage"</span>, ylab <span class="op">=</span> <span class="st">"g(Mileage)"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">yearsold.xx</span>, <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">yearsoldBN</span>, newdata <span class="op">=</span> <span class="va">yearsold.xx</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"l"</span>, 
     main <span class="op">=</span> <span class="st">"Years-old bestNormalizing transformation"</span>, 
     xlab <span class="op">=</span> <span class="st">"Years-old"</span>, ylab <span class="op">=</span> <span class="st">"g(Years-old)"</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/hist_app2-1.png" width="672"></p>
<p>Next, we will fit a linear model on the transformed values of each variable. The reverse-transformation will allow us to visualize how these variables work into the model on their original units.</p>
<p>For the sake of illustration, we also plot the effects of a GAM model to see if there is a big difference. The GAM models seem to be more influenced by outliers than the fits to the transformed data.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">autotrader</span><span class="op">$</span><span class="va">price.t</span> <span class="op">&lt;-</span> <span class="va">priceBN</span><span class="op">$</span><span class="va">x.t</span>
<span class="va">autotrader</span><span class="op">$</span><span class="va">mileage.t</span> <span class="op">&lt;-</span> <span class="va">mileageBN</span><span class="op">$</span><span class="va">x.t</span>
<span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold.t</span> <span class="op">&lt;-</span> <span class="va">yearsoldBN</span><span class="op">$</span><span class="va">x.t</span>

<span class="va">fit4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">price.t</span> <span class="op">~</span> <span class="va">mileage.t</span> <span class="op">+</span> <span class="va">yearsold.t</span>,
           data <span class="op">=</span> <span class="va">autotrader</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span></code></pre></div>
<pre><code>## 
## Call:
## lm(formula = price.t ~ mileage.t + yearsold.t, data = autotrader)
## 
## Residuals:
##     Min      1Q  Median      3Q     Max 
## -2.4252 -0.5778 -0.1247  0.4973  3.1437 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)  0.005454   0.009855   0.553     0.58    
## mileage.t   -0.234321   0.015657 -14.966   &lt;2e-16 ***
## yearsold.t  -0.440999   0.016253 -27.134   &lt;2e-16 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## Residual standard error: 0.781 on 6280 degrees of freedom
## Multiple R-squared:  0.3901, Adjusted R-squared:  0.3899 
## F-statistic:  2009 on 2 and 6280 DF,  p-value: &lt; 2.2e-16</code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">miles.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">mileageBN</span>, newdata <span class="op">=</span> <span class="va">mileage.xx</span><span class="op">)</span>
<span class="va">c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span><span class="op">[</span><span class="st">"mileage.t"</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
    <span class="va">mileageBN</span><span class="op">$</span><span class="va">x.t</span>,
    <span class="va">priceBN</span><span class="op">$</span><span class="va">x.t</span>,
    pch <span class="op">=</span> <span class="fl">16</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.1</span>, alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span>,
    main <span class="op">=</span> <span class="st">"Estimated linear effect (using transformed data)"</span>,
    xlab <span class="op">=</span> <span class="st">"g(Mileage)"</span>,
    ylab <span class="op">=</span> <span class="st">"g(Price)"</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">miles.t</span>,
      <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">c1</span> <span class="op">*</span> <span class="va">miles.t</span>,
      col <span class="op">=</span> <span class="st">"slateblue"</span>,
      lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/app_vis-1.png" width="672"></p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Mileage effect</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
  <span class="va">autotrader</span><span class="op">$</span><span class="va">mileage</span>,
  <span class="va">autotrader</span><span class="op">$</span><span class="va">price</span>,
  pch <span class="op">=</span> <span class="fl">16</span>,
  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.1</span>, alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span>,
  main <span class="op">=</span> <span class="st">"Mileage effect (re-transformed to original unit)"</span>,
  xlab <span class="op">=</span> <span class="st">"Mileage"</span>,
  ylab <span class="op">=</span> <span class="st">"Price"</span>
<span class="op">)</span>
<span class="va">line_vals</span> <span class="op">&lt;-</span> <span class="va">miles.t</span> <span class="op">*</span> <span class="va">c1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>
    <span class="va">mileage.xx</span>,
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">priceBN</span>, newdata <span class="op">=</span> <span class="va">line_vals</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    lwd <span class="op">=</span> <span class="fl">2</span>,
    col <span class="op">=</span> <span class="st">"slateblue"</span>
<span class="op">)</span>
<span class="co"># Compare to GAM fit</span>
<span class="va">fit_gam</span> <span class="op">&lt;-</span> <span class="fu">mgcv</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">price</span> <span class="op">~</span> <span class="fu">s</span><span class="op">(</span><span class="va">yearsold</span><span class="op">)</span> <span class="op">+</span> <span class="fu">s</span><span class="op">(</span><span class="va">mileage</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">autotrader</span><span class="op">)</span>
<span class="va">p_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit_gam</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>yearsold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span><span class="op">)</span>, 
                                               mileage <span class="op">=</span> <span class="va">mileage.xx</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">mileage.xx</span>, <span class="va">p_gam</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'green3'</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span>
  <span class="st">'topright'</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"GAM fit"</span>, <span class="st">"Transformed linear fit"</span><span class="op">)</span>,
  lwd <span class="op">=</span> <span class="fl">2</span>,
  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green3"</span>, <span class="st">"slateblue"</span><span class="op">)</span>,
  bty <span class="op">=</span> <span class="st">"n"</span>
  <span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/app_vis-2.png" width="672"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## Years Old effect</span>
<span class="va">yo.t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">yearsoldBN</span>, newdata <span class="op">=</span> <span class="va">yearsold.xx</span><span class="op">)</span>
<span class="va">c2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span><span class="op">[</span><span class="st">"yearsold.t"</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/jitter.html">jitter</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">yearsold</span>, <span class="fl">1.5</span><span class="op">)</span>,
    <span class="va">autotrader</span><span class="op">$</span><span class="va">price</span>,
    pch <span class="op">=</span> <span class="fl">16</span>,
    col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/gray.html">grey</a></span><span class="op">(</span><span class="fl">.1</span>, alpha <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span>, 
    main <span class="op">=</span> <span class="st">"Years old effect (re-transformed to original unit)"</span>,
    xlab <span class="op">=</span> <span class="st">"Age (Jittered)"</span>,
    ylab <span class="op">=</span> <span class="st">"Price"</span>
<span class="op">)</span>
<span class="va">line_vals</span> <span class="op">&lt;-</span> <span class="va">yo.t</span> <span class="op">*</span> <span class="va">c2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit4</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span>
    <span class="va">yearsold.xx</span>,
    y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">priceBN</span>, newdata <span class="op">=</span> <span class="va">line_vals</span>, inverse <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,
    lwd <span class="op">=</span> <span class="fl">2</span>,
    col <span class="op">=</span> <span class="st">"slateblue"</span>
<span class="op">)</span>

<span class="co"># Compare to GAM fit</span>
<span class="va">p_gam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fit_gam</span>, newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>yearsold <span class="op">=</span> <span class="va">yearsold.xx</span>, 
                                               mileage <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">autotrader</span><span class="op">$</span><span class="va">mileage</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/lines.html">lines</a></span><span class="op">(</span><span class="va">yearsold.xx</span>, <span class="va">p_gam</span>, lwd <span class="op">=</span> <span class="fl">2</span>, col <span class="op">=</span> <span class="st">'green3'</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span>
  <span class="st">'topright'</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"GAM fit"</span>, <span class="st">"Transformed linear fit"</span><span class="op">)</span>,
  lwd <span class="op">=</span> <span class="fl">2</span>,
  col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"green3"</span>, <span class="st">"slateblue"</span><span class="op">)</span>,
  bty <span class="op">=</span> <span class="st">"n"</span>
  <span class="op">)</span></code></pre></div>
<p><img src="bestNormalize_files/figure-html/app_vis-3.png" width="672"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Ryan Andrew Peterson.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
